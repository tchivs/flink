version: v1.0
name: trigger-kdb
agent:
  machine:
    type: s1-prod-ubuntu20-04-amd64-1

global_job_config:
  env_vars:
    - name: CTS_SEMAPHORE_ID
      value: 08033a0d-285d-44a2-82c3-71fb11861ccf

blocks:
  - name: trigger kdb
    skip:
      when: "branch !~ '^release-[0-9]+\\.[0-9]+-confluent$'"
    task:
      jobs:
        - name: trigger kdb
          commands:
            - . vault-setup
            - . vault-sem-get-secret onprem-prod-semaphorebot-api-token
            - 'curl --fail -i -H "Authorization: Token $SEMAPHORE_API_TOKEN" -d "project_id=$CTS_SEMAPHORE_ID&reference=refs/heads/master" -X POST  "https://semaphore.ci.confluent.io/api/v1alpha/plumber-workflows"'
            - 'curl --fail -i -H "Authorization: Token $SEMAPHORE_API_TOKEN" -d "project_id=$CTS_SEMAPHORE_ID&reference=refs/heads/tmp-cts-ea&pipeline-file=.semaphore/dependency-bump.yml" -X POST  "https://semaphore.ci.confluent.io/api/v1alpha/plumber-workflows"'
